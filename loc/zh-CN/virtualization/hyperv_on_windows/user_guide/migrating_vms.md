# 迁移和升级虚拟机 


如果您将虚拟机移动到您最初创建与 HYPER-V 中 Windows 8.1 或更早版本的 Windows 10 主机，您将无法使用新的虚拟机功能，直到您手动更新虚拟机配置版本。 

若要升级配置版本，关闭虚拟机，然后选择在 HYPER-V 管理器中升级虚拟机配置。 

 ```PowerShell
Update-VmVersion <vmname> | <vmobject>
```



## 如何检查在 HYPER-V 上运行的虚拟机的配置版本? 

若要查找配置版本，打开提升的 Windows PowerShell 命令提示符，并运行以下命令:

* * 得到 VM * |格式表名称，版本 * *

PowerShell 命令生成下面的示例输出:

```
Name		State		CPUUsage(%)	MemoryAssigned(M)	Uptime				Status					Version
    
Atlantis	Running			0		1024			 	00:04:20.5910000	Operating normally		5.0
    
SGC VM		Running			0		538 	 			00:02:44.8350000	Operating normally		6.2
```


## 如果我不升级配置版本，会发生什么?

如果你有使用早期版本的 HYPER-V 创建的虚拟机，有些功能可能无法工作与这些虚拟机直到你更新的 VM 版本。

新 HYPER-V 功能相对应的最低 VM 的配置版本:

|* * 功能名称 * * |* * 最低 VM 版本 * * | |
|:------------------------------------- |-----------------: ||
|热添加删除内存 |               6.0 | |
|热添加删除网络适配器 |               5.0 | |
|对于 Linux 虚拟机安全启动 |               6.0 | |
|生产检查站 |               6.0 | |
|PowerShell 直接 |               6.2 | |
|虚拟由受信任的平台模块 (vTPM) |               6.2 | |
|虚拟机分组 |               6.2 | |



## 虚拟机配置版本 ##

当您移动或导入从运行 Windows 8.1 主机上 Windows 10 运行 HYPER-V 主机的虚拟机时，虚拟机的配置文件不会自动升级。这允许虚拟机来运行 Windows 8.1 主机移回。 

虚拟机配置版本代表什么版本的 HYPER-V 虚拟机配置，保存的状态，和快照的文件是与兼容。虚拟机的配置版本 5 兼容 Windows 8.1，可以运行在 Windows 8.1 和 Windows 10。

它是不必要同时升级所有您的虚拟机。您可以选择升级时所需的特定虚拟机。  


----------------
* * 重要 * *

• 您的虚拟机配置版本升级后，你不能将虚拟机移动到运行 Windows 8.1 的主机。

• 您不能降级版本 6 到版本 5 的虚拟机配置版本。

• 您必须先关闭虚拟机升级虚拟机的配置。

• 升级之后，虚拟机使用新的配置文件格式。

--------





## 升级虚拟机的版本时，会发生什么?
当您将虚拟机配置版本手动升级到版本 6.x，您将更改用于存储虚拟机配置文件和检查点文件的文件结构。 

升级后的虚拟机使用新的配置文件格式，为了提高阅读和写作的虚拟机配置数据的效率。 

下表列出的二进制文件的位置和升级后的虚拟机的扩展信息。  

| * * 虚拟机配置文件和检查点文件 (版本 6.x)**|**Description**||
|:---------------|:----------------||
| * * * * 虚拟机配置 |配置信息存储在使用.vmcx 扩展名的二进制文件格式。||
| * * 虚拟机运行时状态 * * |运行时状态数据存储在二进制文件格式，使用.vmrs 扩展名。||
| * * 虚拟机虚拟硬盘 * * |虚拟机的虚拟硬盘文件。他们使用.vhd 或.vhdx 文件扩展名。||
| * * 自动虚拟硬盘文件 * * |差分磁盘文件用于虚拟机检查点。他们使用.avhdx 文件扩展名。||
| * * 检查点文件 * * |检查存储在多个检查点文件中。每个检查点创建一个配置文件和运行时状态文件。检查点文件使用.vmrs 和.vmcx 文件扩展名。这些新的文件格式也用于生产检查站和标准的检查站。

在将虚拟机配置升级后版本 6.x，它是不可能从版本降级 6.x 版本 5。 

必须关闭虚拟机，以升级虚拟机的配置。

下表列出了新的或升级虚拟机的默认文件位置。

|  * * 虚拟机文件 (版本 6.x)** |* * 说明 * * | |
|:-----|:-----||
| * * 虚拟机配置文件 * * |C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual 机 | |
| * * 虚拟机运行时状态文件 * * |C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual 机 | |
| * * 检查点文件 (.vmrs，.vmcx) * * |C:\ProgramData\Microsoft\Windows\Snapshots | |
| * * 虚拟硬盘文件 (.vhd/.vhdx)**|C:\Users\Public\Documents\Hyper-V\Virtual 硬盘 | |
| * * 自动虚拟硬盘文件 (.avhdx) * * |C:\Users\Public\Documents\Hyper-V\Virtual 硬盘 | |




